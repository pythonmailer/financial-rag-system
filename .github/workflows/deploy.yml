  deploy:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          envs: GROQ_API_KEY,GEMINI_API_KEY,OPENROUTER_API_KEY
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."

            # ==========================================
            # 1ï¸âƒ£ Install Docker (official repo) if missing
            # ==========================================
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker (official)..."

              sudo apt update
              sudo apt install -y ca-certificates curl gnupg

              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
                sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg

              echo \
                "deb [arch=$(dpkg --print-architecture) \
                signed-by=/etc/apt/keyrings/docker.gpg] \
                https://download.docker.com/linux/ubuntu \
                $(. /etc/os-release && echo $VERSION_CODENAME) stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

              sudo apt update
              sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            # ==========================================
            # 2ï¸âƒ£ Ensure docker group permissions
            # ==========================================
            sudo usermod -aG docker ubuntu || true

            # ==========================================
            # 3ï¸âƒ£ Verify docker compose (self-heal fallback)
            # ==========================================
            if ! docker compose version &> /dev/null; then
              echo "âš ï¸ docker compose plugin missing â†’ installing fallback docker-compose binary..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" \
                -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              alias docker-compose='docker-compose'
            fi

            # ==========================================
            # 4ï¸âƒ£ Clone repo if missing
            # ==========================================
            if [ ! -d "$HOME/financial-rag-system" ]; then
              echo "ğŸ“¦ Cloning repository..."
              git clone https://github.com/pythonmailer/financial-rag-system ~/financial-rag-system
            fi

            cd ~/financial-rag-system

            echo "ğŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main

            # ==========================================
            # 5ï¸âƒ£ Write .env
            # ==========================================
            echo "ğŸ“ Writing .env file..."
            cat > .env <<EOF
            GROQ_API_KEY=${GROQ_API_KEY}
            GEMINI_API_KEY=${GEMINI_API_KEY}
            OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
            DATABASE_URL=postgresql://admin:adminpassword@postgres:5432/financial_rag
            TESTING=False
            USE_GPU=False
            QDRANT_URL=http://qdrant:6333
            EOF

            # ==========================================
            # 6ï¸âƒ£ Stop old containers safely
            # ==========================================
            echo "ğŸ›‘ Stopping old containers (if any)..."
            docker compose down || true
            docker-compose down || true

            # ==========================================
            # 7ï¸âƒ£ Clean unused images (safe)
            # ==========================================
            echo "ğŸ§¹ Cleaning old images..."
            docker image prune -f || true

            # ==========================================
            # 8ï¸âƒ£ Start stack (supports both compose syntaxes)
            # ==========================================
            echo "ğŸ”„ Rebuilding and starting containers..."
            docker compose up -d --build || docker-compose up -d --build

            # ==========================================
            # 9ï¸âƒ£ Wait for backend health
            # ==========================================
            echo "â³ Waiting for backend health..."
            for i in {1..30}; do
              if curl -s http://localhost:8001/ready | grep -q '"ready"'; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "â³ Waiting for backend... ($i/30)"
              sleep 5
            done

            # ==========================================
            # ğŸ”Ÿ Run Alembic migrations if available
            # ==========================================
            if docker compose exec -T backend alembic current &> /dev/null; then
              echo "ğŸ“¦ Running Alembic migrations..."
              docker compose exec -T backend alembic upgrade head || true
            else
              echo "â„¹ï¸ Alembic not configured â€” skipping migrations"
            fi

            echo "ğŸ‰ Deployment complete!"